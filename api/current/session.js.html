<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: backbone-x/source/ext/session.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: backbone-x/source/ext/session.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/*jshint indent:2, curly:true, eqeqeq:true, immed:true, latedef:true,
newcap:true, noarg:true, regexp:true, undef:true, strict:true, trailing:true,
white:true*/
/*global XT:true, XM:true, Backbone:true, _:true, console:true, setTimeout: true, enyo:true */

(function () {
  "use strict";

  /**
    @class XT.Session
    @name XT.Session
  */
  _.extend(XT.Session, /** @lends XT.Session# */{

    privileges: {},
    relevantPrivileges: [], // those privileges that are needed for an active extension

    /*

    // privilege segments generated by
    var privs = [
    "ViewProjectBudget",
    ...
    "ViewProjectFinancialReport"
    ];

    var objects = [
      {label: "Account", keywords: ["Account"]},
      {label: "Contact", keywords: ["Contact", "Honorific", "Title"]},
      {label: "ToDo", keywords: ["ToDo"]},
      {label: "Opportunity", keywords: ["Opportunit"]},
      {label: "Incident", keywords: ["Incident", "EmailProfiles"]},
      {label: "Project", keywords: ["Project"]},
      {label: "Customer", keywords: ["Customer"]},
      {label: "SalesOrder", keywords: ["SalesOrder"]},
      {label: "Tax", keywords: ["Tax"]},
      {label: "Currency", keywords: ["Currenc"]},
      {label: "Address", keywords: ["Address", "Country", "State"]},
      {label: "Item", keywords: ["ItemMaster"]}
    ];

    var globalMatched = [];
    _.each(objects, function (obj) {
      var allMatched = [];
      _.each(obj.keywords, function (keyword) {
        var matched = _.filter(privs, function (priv) {
          return priv.indexOf(keyword) >= 0;
        });
        allMatched = _.union(allMatched, matched);
        globalMatched = _.union(globalMatched, matched);
      });
      console.log(obj.label + ":", allMatched, ",");
    });
    */


    privilegeSegments: {
      Account: ["MaintainBankAccounts", "MaintainAccountingPeriods", "ViewAccountingPeriods", "MaintainSalesAccount", "ViewSalesAccount", "MaintainChartOfAccounts", "MaintainVendorAccounts", "ViewVendorAccounts", "MaintainAllCRMAccounts", "ViewAllCRMAccounts", "MaintainPersonalCRMAccounts", "ViewPersonalCRMAccounts", "ViewBankAccountsDock", "ViewGLAccountsDock", "ViewMyAccountsDock", "ViewAccountingDesktop"],
      Contact: ["MergeContacts", "MaintainAllContacts", "ViewAllContacts", "MaintainPersonalContacts", "ViewPersonalContacts", "ViewMyContactsDock", "MaintainTitles", "ViewTitles"],
      ToDo: ["ReassignToDoItems", "ViewAllToDoItems", "MaintainAllToDoItems", "MaintainPersonalToDoItems", "ViewPersonalToDoItems"],
      Opportunity: ["MaintainOpportunitySources", "MaintainOpportunityStages", "MaintainOpportunityTypes", "MaintainAllOpportunities", "ViewAllOpportunities", "MaintainPersonalOpportunities", "ViewPersonalOpportunities"],
      Incident: ["MaintainIncidentCategories", "MaintainIncidentPriorities", "MaintainIncidentSeverities", "MaintainIncidentResolutions", "CloseAllIncidents", "ClosePersonalIncidents", "MaintainAllIncidents", "ViewAllIncidents", "MaintainPersonalIncidents", "ViewPersonalIncidents", "ViewPersonalIncidentHistory", "MaintainEmailProfiles"],
      Project: ["MaintainAllProjects", "ViewAllProjects", "MaintainPersonalProjects", "ViewPersonalProjects", "ViewProjectBudget", "ViewProjectFinancialReport"],
      Customer: ["ViewCustomerMasters", "ViewCustomerTypes", "MaintainCustomerTypes", "UpdateCustomerCreditStatus", "ViewCustomerPrices", "MaintainCustomerGroups", "ViewCustomerGroups", "CreateSOForHoldCustomer", "CreateSOForWarnCustomer", "UpdateCustomerCreditStatus", "MaintainCustomerMastersCustomerType", "MaintainCustomerMastersCustomerTypeOnCreate", "MaintainCustomerMasters"],
      Quote: ["MaintainQuotes", "ViewQuotes"],
      SalesOrder: ["MaintainSalesOrders", "ViewSalesOrders", "ShowMarginsOnSalesOrder", "FirmSalesOrder", "ViewSalesOrdersDock", "OverridePrice", "CreateSOForHoldCustomer", "CreateSOForWarnCustomer", "OverrideSODate", "AlterPackDate"],
      Tax: ["MaintainTaxAuthorities", "ViewTaxAuthorities", "MaintainTaxTypes", "ViewTaxTypes", "OverrideTax", "MaintainTaxReconciliations", "ViewTaxReconciliations", "MaintainTaxCodes", "ViewTaxCodes", "ViewTaxZones", "MaintainTaxZones", "ViewTaxClasses", "MaintainTaxClasses", "MaintainTaxAssignments", "ViewTaxAssignments", "MaintainTaxRegistrations", "ViewTaxRegistrations"],
      Currency: ["CreateNewCurrency", "MaintainCurrencies", "MaintainCurrencyRates", "ViewCurrencyRates"],
      Address: ["ViewVendorAddresses", "MaintainVendorAddresses", "MaintainAddresses", "ViewAddresses", "MaintainStates"],
      Item: ["ViewItemMasters", "MaintainItemMasters", "DeleteItemMasters"],
      ItemSite: ["ViewItemSites", "MaintainItemSites", "DeleteItemSites"],
      Inventory: ["MaintainCarriers", "ViewShipping", "ViewLocations", "ViewInventoryAvailability", "CreateAdjustmentTrans", "CreateScrapTrans", "CreateReceiptTrans", "CreateInterWarehouseTrans", "MaintainItemSites", "ViewItemSites", "PostCountSlips", "EnterCountSlips", "DeleteCountTags", "ZeroCountTags", "ViewCountTags", "PostCountTags", "PurgeCountSlips", "PurgeCountTags", "ViewInventoryValue", "RelocateInventory", "ReassignLotSerial", "ViewQOH", "UpdateCycleCountFreq", "UpdateLeadTime", "SummarizeInventoryTransactions", "ThawInventory", "MaintainCostCategories", "ViewCostCategories", "DeleteCountSlips", "PrintBillsOfLading", "ShipOrders", "ReturnStockFromShipping", "IssueStockToShipping", "PurgeShippingRecords", "ViewDestinations", "MaintainDestinations", "EnterShippingInformation", "RecallOrders", "ViewCarriers", "EnterReceipts", "EnterReturns", "UpdateOUTLevels", "UpdateReorderLevels", "MaintainPackingListBatch", "ViewPackingListBatch", "MaintainCharacteristics",
"ViewCharacteristics", "DeleteItemSites", "CreateExpenseTrans", "CreateTransformTrans", "RecallInvoicedShipment", "ViewItemAvailabilityWorkbench", "MaintainTransferOrders", "ViewTransferOrders", "OverrideTODate", "ViewInventoryHistory", "ViewWarehouses", "MaintainWarehouses", "UpdateABCClass", "FreezeInventory", "EnterMiscCounts", "IssueCountTags", "EnterCountTags", "MaintainLocations", "AlterTransactionDates", "MaintainExternalShipping", "MaintainSiteTypes", "ViewSiteTypes", "ReleaseTransferOrders"]
    },
    settings: {},
    schemas: {
      XM: false // false means we have not yet fetched it
    },

    SETTINGS: 0x01,
    PRIVILEGES: 0x02,
    SCHEMA: 0x04,
    LOCALE: 0x08, // no longer used
    PREFERENCES: 0x10,
    ALL: 0x01 | 0x02 | 0x04 | 0x08 | 0x10,

    /**
      Loads session objects for settings, preferences and privileges into local
      memory. Types `XT.session.SETTINGS` or `XT.session.PRIVILEGES` can be passed
      as bitwise operators. If no arguments are passed the default is
      `XT.session.ALL` which will load all session objects.

      @param {Number} Types
      @param {Object} Options
    */
    loadSessionObjects: function (types, options) {
      var that = this,
        privilegesOptions,
        settingsOptions,
        settings,
        schemaOptions,
        preferencesOptions,
        extensionOptions,
        callback,
        schemaCount = 0,
        schemasReturned = 0,
        i;

      if (options && options.success && options.success instanceof Function) {
        callback = options.success;
      } else {
        callback = function () {};
      }

      if (types === undefined) { types = this.ALL; }

      if (types & this.PRIVILEGES) {
        privilegesOptions = options ? _.clone(options) : {};

        // callback
        privilegesOptions.success = function (resp) {
          var privileges, i;

          if (that.getPrivileges().attributes) {
            // add incoming data to already loaded privilege
            privileges = that.getPrivileges();

          } else {
            // create privilege as a new model
            privileges = new Backbone.Model();
            privileges.get = function (attr) {
              // Sometimes the answer is already known...
              if (_.isBoolean(attr)) { return attr; }
              return Backbone.Model.prototype.get.call(this, attr);
            };
          }

          // Loop through the response and set a privilege for each found.
          for (i = 0; i &lt; resp.length; i++) {
            privileges.set(resp[i].privilege, resp[i].isGranted);
          }

          // Attach the privileges to the session object.
          that.setPrivileges(privileges);
          callback();
        };

        XM.ModelMixin.dispatch('XT.Session', 'privileges', null, privilegesOptions);

      }

      if (types & this.SETTINGS) {
        settingsOptions = options ? _.clone(options) : {};

        // callback
        settingsOptions.success = function (resp) {
          settings = new Backbone.Model(resp);

          // Attach the settings to the session object
          that.setSettings(settings);

          callback();
        };

        XM.ModelMixin.dispatch('XT.Session', 'settings', null, settingsOptions);
      }

      if (types & this.SCHEMA) {
        schemaOptions = options ? _.clone(options) : {};

        // callback
        schemaOptions.success = function (resp, options) {
          var schema,
            prop,
            Klass,
            relations,
            rel,
            obj,
            proto,
            i;

          if (that.getSchemas()[options.schemaName].attributes) {
            // add incoming data to already loaded schema attributes
            schema = that.getSchemas()[options.schemaName];
            schema.set(resp);

          } else {
            // create schema as a new model
            schema = new Backbone.Model(resp);
            that.setSchema(options.schemaName, schema);
          }
          schemasReturned++;

          if (schemasReturned === schemaCount) {
            _.each(that.getSchemas(), function (schema, schemaName) {
              // Set relations
              for (var prop in schema.attributes) {
                if (schema.attributes.hasOwnProperty(prop)) {
                  Klass = XM.Model.getObjectByName(schemaName + '.' + prop);
                  if (Klass) {
                    proto = Klass.prototype;
                    obj = schema.attributes[prop];
                    relations = obj.relations || [];
                    if (relations.length) {
                      proto.relations = [];
                      for (i = 0; i &lt; relations.length; i++) {
                        rel = relations[i];
                        if (rel.type === "Backbone.HasOne") {
                          rel.type = Backbone.HasOne;
                        } else if (rel.type === "Backbone.HasMany") {
                          rel.type = Backbone.HasMany;
                        } else {
                          continue;
                        }
                        proto.relations.push(rel);
                      }
                    }

                    proto.idAttribute = obj.idAttribute;
                    proto.lockable = obj.lockable;
                    if (obj.privileges) {
                      // don't overwrite a privilege with undefined if it's
                      // already defined in the model, e.g. XM.Settings
                      proto.privileges = obj.privileges;
                    }
                    proto.requiredAttributes = obj.requiredAttributes;
                  }
                }
              }
            });
            callback();
          }
        };

        schemaOptions.error = function () {
          console.log("schema error", arguments);
        };

        _.each(this.schemas, function (value, schemaName) {
          // get schema for instance DB models
          schemaOptions.schemaName = schemaName;
          XM.ModelMixin.dispatch('XT.Session', 'schema', schemaName.toLowerCase(), schemaOptions);
          schemaCount++;
        });
      }

      if (types & this.PREFERENCES) {
        preferencesOptions = options ? _.clone(options) : {};

        // callback
        preferencesOptions.success = function (resp) {
          var preferences = new XM.UserPreference(resp);
          that.setPreferences(preferences);
          callback();
        };

        XM.ModelMixin.dispatch('XT.Session', 'preferences', null, preferencesOptions);
      }

      return true;
    },

    getPreferences: function () {
      return this.preferences;
    },

    getSchemas: function () {
      return this.schemas;
    },

    getSettings: function () {
      return this.settings;
    },

    getPrivileges: function () {
      return this.privileges;
    },

    setPreferences: function (value) {
      this.preferences = value;
      return this;
    },

    setSchema: function (schemaName, value) {
      this.schemas[schemaName] = value;
      return this;
    },

    setSettings: function (value) {
      this.settings = value;
      return this;
    },

    setPrivileges: function (value) {
      this.privileges = value;
      return this;
    },

    /**
      Each extension has a set of privileges that it cares about. The extension will load those
      privileges here into the session object with then name of the module that the privilege
      should be associated with. The module name will frequently be the extension name, but some
      extensions do not have their own modules.

      @param {String} module
      @param {Array} privArray
    */
    addRelevantPrivileges: function (module, privArray) {
      var privMap = _.map(privArray, function (priv) {return {module: module, privilege: priv}; });
      this.relevantPrivileges = _.union(this.relevantPrivileges, privMap);
    },

    // ..........................................................
    // CLASS CONSTANTS
    //

    DB_BOOLEAN: 'B',
    DB_STRING: 'S',
    DB_COMPOUND: 'C',
    DB_DATE: 'D',
    DB_NUMBER: 'N',
    DB_ARRAY: 'A',
    DB_BYTEA: 'U',
    DB_UNKNOWN: 'X'

  });

}());
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="XM.Alarm.html">Alarm</a></li><li><a href="XM.Characteristic.html">Characteristic</a></li><li><a href="XM.CharacteristicAssignment.html">CharacteristicAssignment</a></li><li><a href="XM.CharacteristicCollection.html">CharacteristicCollection</a></li><li><a href="XM.CharacteristicOption.html">CharacteristicOption</a></li><li><a href="XM.Collection.html">Collection</a></li><li><a href="XM.Comment.html">Comment</a></li><li><a href="XM.CommentType.html">CommentType</a></li><li><a href="XM.CommentTypeCollection.html">CommentTypeCollection</a></li><li><a href="XM.CommentTypeSource.html">CommentTypeSource</a></li><li><a href="XM.Document.html">Document</a></li><li><a href="XM.EnumMapCollection.html">EnumMapCollection</a></li><li><a href="XM.Info.html">Info</a></li><li><a href="XM.Model.html">Model</a></li><li><a href="XM.Settings.html">Settings</a></li><li><a href="XM.SimpleModel.html">SimpleModel</a></li><li><a href="XM.Source.html">Source</a></li><li><a href="XM.SourceCollection.html">SourceCollection</a></li><li><a href="XM.StaticCollection.html">StaticCollection</a></li><li><a href="XM.StaticModel.html">StaticModel</a></li><li><a href="XM.Workflow.html">Workflow</a></li><li><a href="XM.WorkflowSource.html">WorkflowSource</a></li><li><a href="XT.DataSource.html">DataSource</a></li><li><a href="XT.Error.html">Error</a></li><li><a href="XT.Foundation.html">Foundation</a></li><li><a href="XT.Session.html">Session</a></li><li><a href="XV.AddressFieldsWidget.html">AddressFieldsWidget</a></li><li><a href="XV.AddressWidget.html">AddressWidget</a></li><li><a href="XV.AssignmentBox.html">AssignmentBox</a></li><li><a href="XV.CharacteristicItem.html">CharacteristicItem</a></li><li><a href="XV.CharacteristicPicker.html">CharacteristicPicker</a></li><li><a href="XV.CharacteristicsWidget.html">CharacteristicsWidget</a></li><li><a href="XV.ChildWorkspace.html">ChildWorkspace</a></li><li><a href="XV.ChildWorkspaceContainer.html">ChildWorkspaceContainer</a></li><li><a href="XV.Column.html">Column</a></li><li><a href="XV.ComboboxWidget.html">ComboboxWidget</a></li><li><a href="XV.CommentBox.html">CommentBox</a></li><li><a href="XV.CommentBoxItem.html">CommentBoxItem</a></li><li><a href="XV.CommentTypePicker.html">CommentTypePicker</a></li><li><a href="XV.Completer.html">Completer</a></li><li><a href="XV.DateWidget.html">DateWidget</a></li><li><a href="XV.DependenciesWidget.html">DependenciesWidget</a></li><li><a href="XV.DependencyItem.html">DependencyItem</a></li><li><a href="XV.DependencyPicker.html">DependencyPicker</a></li><li><a href="XV.DocumentListRelations.html">DocumentListRelations</a></li><li><a href="XV.DocumentsBox.html">DocumentsBox</a></li><li><a href="XV.EditorMixin.html">EditorMixin</a></li><li><a href="XV.ExtensionsMixin.html">ExtensionsMixin</a></li><li><a href="XV.FileInput.html">FileInput</a></li><li><a href="XV.FormattingMixin.html">FormattingMixin</a></li><li><a href="XV.GridAttr.html">GridAttr</a></li><li><a href="XV.GridRow.html">GridRow</a></li><li><a href="XV.Groupbox.html">Groupbox</a></li><li><a href="XV.IconButton.html">IconButton</a></li><li><a href="XV.InputWidget.html">InputWidget</a></li><li><a href="XV.List.html">List</a></li><li><a href="XV.ListAttr.html">ListAttr</a></li><li><a href="XV.ListBase.html">ListBase</a></li><li><a href="XV.ListBox.html">ListBox</a></li><li><a href="XV.ListColumn.html">ListColumn</a></li><li><a href="XV.ListItem.html">ListItem</a></li><li><a href="XV.ListRelations.html">ListRelations</a></li><li><a href="XV.ListRelationsBox.html">ListRelationsBox</a></li><li><a href="XV.ListRelationsEditorBox.html">ListRelationsEditorBox</a></li><li><a href="XV.MenuItem.html">MenuItem</a></li><li><a href="XV.ModuleContainer.html">ModuleContainer</a></li><li><a href="XV.Navigator.html">Navigator</a></li><li><a href="XV.Number.html">Number</a></li><li><a href="XV.OptionsPicker.html">OptionsPicker</a></li><li><a href="XV.ParameterItem.html">ParameterItem</a></li><li><a href="XV.ParameterWidget.html">ParameterWidget</a></li><li><a href="XV.Picker.html">Picker</a></li><li><a href="XV.Pullout.html">Pullout</a></li><li><a href="XV.RelationsEditor.html">RelationsEditor</a></li><li><a href="XV.RelationWidget.html">RelationWidget</a></li><li><a href="XV.ScreenCarousel.html">ScreenCarousel</a></li><li><a href="XV.Scroller.html">Scroller</a></li><li><a href="XV.SearchContainer.html">SearchContainer</a></li><li><a href="XV.StickyCheckboxWidget.html">StickyCheckboxWidget</a></li><li><a href="XV.TextArea.html">TextArea</a></li><li><a href="XV.ToggleButtonWidget.html">ToggleButtonWidget</a></li><li><a href="XV.Tree.html">Tree</a></li><li><a href="XV.TreeNode.html">TreeNode</a></li><li><a href="XV.Workspace.html">Workspace</a></li><li><a href="XV.WorkspaceContainer.html">WorkspaceContainer</a></li></ul><h3>Namespaces</h3><ul><li><a href="XM.html">XM</a></li><li><a href="XT.html">XT</a></li><li><a href="XV.html">XV</a></li></ul><h3>Global</h3><ul><li><a href="global.html#apply">apply</a></li><li><a href="global.html#changed">changed</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#close">close</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#destroyWorkspace">destroyWorkspace</a></li><li><a href="global.html#email">email</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#errorNotify">errorNotify</a></li><li><a href="global.html#fetch">fetch</a></li><li><a href="global.html#handleHotKey">handleHotKey</a></li><li><a href="global.html#headerChanged">headerChanged</a></li><li><a href="global.html#headerValuesChanged">headerValuesChanged</a></li><li><a href="global.html#inputChanged">inputChanged</a></li><li><a href="global.html#isDirty">isDirty</a></li><li><a href="global.html#itemTap">itemTap</a></li><li><a href="global.html#lockTapped">lockTapped</a></li><li><a href="global.html#menuChanged">menuChanged</a></li><li><a href="global.html#modelSaved">modelSaved</a></li><li><a href="global.html#newRecord">newRecord</a></li><li><a href="global.html#notify">notify</a></li><li><a href="global.html#openReport">openReport</a></li><li><a href="global.html#popupHidden">popupHidden</a></li><li><a href="global.html#print">print</a></li><li><a href="global.html#recordIdChanged">recordIdChanged</a></li><li><a href="global.html#requery">requery</a></li><li><a href="global.html#save">save</a></li><li><a href="global.html#saveAndClose">saveAndClose</a></li><li><a href="global.html#saveAndNew">saveAndNew</a></li><li><a href="global.html#saveTextChanged">saveTextChanged</a></li><li><a href="global.html#setupItem">setupItem</a></li><li><a href="global.html#setValue">setValue</a></li><li><a href="global.html#setWorkspace">setWorkspace</a></li><li><a href="global.html#spinnerHide">spinnerHide</a></li><li><a href="global.html#spinnerShow">spinnerShow</a></li><li><a href="global.html#statusChanged">statusChanged</a></li><li><a href="global.html#titleChanged">titleChanged</a></li><li><a href="global.html#valueChanged">valueChanged</a></li><li><a href="global.html#workspace">workspace</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.2</a> on Fri Jul 10 2015 16:42:51 GMT-0000 (UTC)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
