<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title> xTuple ERP Programmer Reference: ccvoid.js</title>
<link href="xtuple_doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>ccvoid.js</h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * This file is part of the xTuple ERP: PostBooks Edition, a free and</span>
<span class="comment"> * open source Enterprise Resource Planning software suite,</span>
<span class="comment"> * Copyright (c) 1999-2010 by OpenMFG LLC, d/b/a xTuple.</span>
<span class="comment"> * It is licensed to you under the Common Public Attribution License</span>
<span class="comment"> * version 1.0, the full text of which (including xTuple-specific Exhibits)</span>
<span class="comment"> * is available at www.xtuple.com/CPAL.  By using this software, you agree</span>
<span class="comment"> * to be bound by its terms.</span>
<span class="comment"> */</span>

<span class="comment">/* a completely scripted implementation of voiding previously-created</span>
<span class="comment">   credit card transactions through authorize.net. the window</span>
<span class="comment">   contains a list of transactions available to void, a button to</span>
<span class="comment">   void the currently-selected transaction, and a close button.</span>
<span class="comment"> */</span>

var _ccp    = toolbox.getCreditCardProcessor();
<span class="keywordflow">if</span> (_ccp == null)
  <a name="_a0"></a><a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;No Credit Card Processor&quot;</span>),
                       qsTr(<span class="stringliteral">&quot;Could not get a credit card processor&quot;</span>));
var _currid = -1;
var _transactions = mywindow.findChild(<span class="stringliteral">&quot;_transactions&quot;</span>);
var _void         = mywindow.findChild(<span class="stringliteral">&quot;_void&quot;</span>);

<span class="comment">// with authorize.net, the CCServer is really a full url except for the port</span>
var _url = <span class="keyword">new</span> <a name="_a1"></a><a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qurl.html">QUrl</a>(metrics.value(<span class="stringliteral">&quot;CCServer&quot;</span>));
<span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCPort&quot;</span>) &gt; 0)
   _url.setPort(metrics.value(<span class="stringliteral">&quot;CCPort&quot;</span>));
<span class="keywordflow">else</span>
   _url.setPort(_ccp.defaultPort());

var _netmgr = <span class="keyword">new</span> <a name="_a2"></a><a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qnetworkaccessmanager.html">QNetworkAccessManager</a>(mywindow);

<span class="comment">// network requests are asynchronous; let sHandleResponse deal with the reply when it comes</span>
_netmgr.authenticationRequired.connect(sHandleAuthenticationRequired);
_netmgr.proxyAuthenticationRequired.connect(sHandleProxyAuthenticationRequired);
_netmgr.sslErrors.connect(sHandleSslError);

_netmgr.finished.connect(sHandleResponse);
_void.clicked.connect(sVoid);

_transactions.addColumn(<span class="stringliteral">&quot;Cust. #&quot;</span>,     -1, 1, <span class="keyword">true</span>, <span class="stringliteral">&quot;cust_number&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Name&quot;</span>,        -1, 1, <span class="keyword">true</span>, <span class="stringliteral">&quot;cust_name&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Type&quot;</span>,        -1, 1, <span class="keyword">true</span>, <span class="stringliteral">&quot;type&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Transaction&quot;</span>, -1, 1, <span class="keyword">true</span>, <span class="stringliteral">&quot;status&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Order-Seq.&quot;</span>,  -1, 2, <span class="keyword">true</span>, <span class="stringliteral">&quot;docnumber&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Amount&quot;</span>,      -1, 2, <span class="keyword">true</span>, <span class="stringliteral">&quot;ccpay_amount&quot;</span>);
_transactions.addColumn(<span class="stringliteral">&quot;Currency&quot;</span>,    -1, 1, <span class="keyword">true</span>, <span class="stringliteral">&quot;ccpay_currAbbr&quot;</span>);

function sHandleAuthenticationRequired(reply, authenticator)
{
  print(<span class="stringliteral">&quot;sHandleAuthenticationRequired called&quot;</span>);
  toolbox.listProperties(reply);
  toolbox.listProperties(authenticator);
}

function sHandleProxyAuthenticationRequired(proxy, authenticator)
{
  print(<span class="stringliteral">&quot;sHandleProxyAuthenticationRequired called&quot;</span>);
  toolbox.listProperties(proxy);
  toolbox.listProperties(authenticator);
}

function sHandleSslError(reply, errors)
{
  print(<span class="stringliteral">&quot;sHandleSslError called&quot;</span>);
  toolbox.listProperties(reply);
  toolbox.listProperties(errors);
}

function sPopulateTransactions()
{
  var params = <span class="keyword">new</span> Object;

  params.preauth        = <span class="stringliteral">&quot;Preauthorization&quot;</span>;
  params.charge         = <span class="stringliteral">&quot;Charge&quot;</span>;
  params.refund         = <span class="stringliteral">&quot;Refund/Credit&quot;</span>;
  params.authorized     = <span class="stringliteral">&quot;Authorized&quot;</span>;
  params.approved       = <span class="stringliteral">&quot;Approved&quot;</span>;
  params.declined       = <span class="stringliteral">&quot;Declined/Denied&quot;</span>;
  params.voided         = <span class="stringliteral">&quot;Voided&quot;</span>;
  params.noapproval     = <span class="stringliteral">&quot;Not Approved&quot;</span>;
  <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCValidDays&quot;</span>) &gt; 0)
    params.ccValidDays  = metrics.value(<span class="stringliteral">&quot;CCValidDays&quot;</span>);
  <span class="keywordflow">else</span>
    params.ccValidDays  = 7;

  _transactions.populate(toolbox.executeDbQuery(<span class="stringliteral">&quot;ccpayments&quot;</span>, <span class="stringliteral">&quot;list&quot;</span>, params));
}

<span class="comment">// convenience function to help build the message to send</span>
function <a name="a3"></a><a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(request, name, content)
{
  <span class="keywordflow">if</span> (request != <span class="stringliteral">&quot;&quot;</span>)
    request = request + <span class="stringliteral">&quot;&amp;&quot;</span>;
  <span class="keywordflow">return</span> request + name + <span class="stringliteral">&quot;=&quot;</span> + content;
}

<span class="comment">/* this was translated from the C++ sources</span>
<span class="comment">   authorizedotnetprocessor.cpp and creditcardprocessor.cpp</span>
<span class="comment"> */</span>
function sVoid()
{
  <span class="keywordflow">try</span> {
    <span class="comment">// local error checks</span>
    <span class="keywordflow">if</span> (_transactions.currentItem().text(<span class="stringliteral">&quot;status&quot;</span>) == <span class="stringliteral">&quot;Voided&quot;</span>)
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.warning(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),
                          qsTr(<span class="stringliteral">&quot;This transaction cannot be voided a second time.&quot;</span>));
      <span class="keywordflow">return</span>;
    }

    <span class="comment">// build the message</span>
    var params = <span class="keyword">new</span> Object;
    params.ccpayid = _transactions.id;
    params.key     = mainwindow.key;
    var anq = toolbox.executeQuery(
          <span class="stringliteral">&quot;SELECT ccard_active,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_number),   setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;))   AS ccard_number,&quot;</span>
        + <span class="stringliteral">&quot;  formatccnumber(decrypt(setbytea(ccard_number),setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_number_x,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_name),     setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_name,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_address1), setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_address1,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_address2), setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_address2,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_city),     setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_city,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_state),    setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_state,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_zip),      setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_zip,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_country),  setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_country,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_month_expired),setbytea(&lt;? value(\&quot;key\&quot; ?&gt;),&apos;bf&apos;)) AS ccard_month_expired,&quot;</span>
        + <span class="stringliteral">&quot;  formatbytea(decrypt(setbytea(ccard_year_expired),setbytea(&lt;? value(\&quot;key\&quot; ?&gt;), &apos;bf&apos;)) AS ccard_year_expired,&quot;</span>
        + <span class="stringliteral">&quot;  cust.*,&quot;</span>
        + <span class="stringliteral">&quot;  ccpay.*,&quot;</span>
        + <span class="stringliteral">&quot;  curr_symbol.*&quot;</span>
        + <span class="stringliteral">&quot;  FROM ccard, cust, ccpay, curr_symbol &quot;</span>
        + <span class="stringliteral">&quot;WHERE ((ccard_cust_id=cust_id)&quot;</span>
        + <span class="stringliteral">&quot;  AND  (ccard_id=ccpay_ccard_id)&quot;</span>
        + <span class="stringliteral">&quot;  AND  (curr_id=ccpay_curr_id)&quot;</span>
        + <span class="stringliteral">&quot;  AND  (ccpay_id=&lt;? value(\&quot;ccpayid\&quot;) ?&gt;));&quot;</span>,
          params);

    <span class="keywordflow">if</span> (anq.first())
    {
      <span class="keywordflow">if</span> (! anq.value(<span class="stringliteral">&quot;ccard_active&quot;</span>))
      {
        <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),
                             _ccp.errorMsg(-10).replace(<span class="stringliteral">&quot;%1&quot;</span>, anq.value(<span class="stringliteral">&quot;ccard_number_x&quot;</span>)));
        <span class="keywordflow">return</span> -10;
      }
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (anq.lastError().type != 0)
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>),
                           qsTr(<span class="stringliteral">&quot;A database error occurred: %1&quot;</span>).arg(anq.lastError().text));
      <span class="keywordflow">return</span> -1;
    }
    <span class="keywordflow">else</span>
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Cannot Void&quot;</span>), _ccp.errorMsg(-17));
      <span class="keywordflow">return</span> -17;
    }

    var prequest = <span class="stringliteral">&quot;&quot;</span>;
    _currid = anq.value(<span class="stringliteral">&quot;ccpay_curr_id&quot;</span>);
    <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>).length &gt; 0)
      prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_delim_char&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>));

    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_version&quot;</span>,      metrics.value(<span class="stringliteral">&quot;CCANVer&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_delim_data&quot;</span>, <span class="stringliteral">&quot;TRUE&quot;</span>);

    <span class="keywordflow">if</span> (metrics.value(<span class="stringliteral">&quot;CCANEncap&quot;</span>).length &gt; 0)
      prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_encap_char&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANEncap&quot;</span>));

    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_login&quot;</span>,    metricsenc.value(<span class="stringliteral">&quot;CCLogin&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_tran_key&quot;</span>, metricsenc.value(<span class="stringliteral">&quot;CCPassword&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_amount&quot;</span>,   _transactions.column(<span class="stringliteral">&quot;ccpay_amount&quot;</span>).text);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_card_num&quot;</span>, anq.value(<span class="stringliteral">&quot;ccard_number&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_test_request&quot;</span>, _ccp.isLive() ? <span class="stringliteral">&quot;FALSE&quot;</span> : <span class="stringliteral">&quot;TRUE&quot;</span>);

    var work_month = anq.value(<span class="stringliteral">&quot;ccard_month_expired&quot;</span>);
    <span class="keywordflow">if</span> (work_month &lt; 10 &amp;&amp; work_month &gt; 0)
      work_month = <span class="stringliteral">&quot;0&quot;</span> + work_month;
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_exp_date&quot;</span>,
                           work_month + anq.value(<span class="stringliteral">&quot;ccard_year_expired&quot;</span>) % 100);

    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_relay_response&quot;</span>, <span class="stringliteral">&quot;FALSE&quot;</span>);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_duplicate_window&quot;</span>, metrics.value(<span class="stringliteral">&quot;CCANDuplicateWindow&quot;</span>));

    var name = anq.value(<span class="stringliteral">&quot;ccard_name&quot;</span>).split(/\s+/);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_first_name&quot;</span>, name[0]);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_last_name&quot;</span>,  name[name.length - 1]);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_company&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_name&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_address&quot;</span>,    anq.value(<span class="stringliteral">&quot;ccard_address1&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_city&quot;</span>,       anq.value(<span class="stringliteral">&quot;ccard_city&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_state&quot;</span>,      anq.value(<span class="stringliteral">&quot;ccard_state&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_zip&quot;</span>,        anq.value(<span class="stringliteral">&quot;ccard_zip&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_country&quot;</span>,    anq.value(<span class="stringliteral">&quot;ccard_country&quot;</span>));

    <span class="keywordflow">if</span> (metrics.CCANWellsFargoSecureSource)
    {
      prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_phone&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_phone&quot;</span>));
      prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_email&quot;</span>,    anq.value(<span class="stringliteral">&quot;cust_email&quot;</span>));
    }

    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_currency_code&quot;</span>, anq.value(<span class="stringliteral">&quot;curr_abbr&quot;</span>));
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_method&quot;</span>,        <span class="stringliteral">&quot;CC&quot;</span>);
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_type&quot;</span>,          <span class="stringliteral">&quot;VOID&quot;</span>);
    
    prequest = <a class="code" href="authorizedotnetprocessor_8cpp.html#a6131a487bde902aa8cf109d087607aea">APPENDFIELD</a>(prequest, <span class="stringliteral">&quot;x_trans_id&quot;</span>,
                           _ccp.isLive() ? anq.value(<span class="stringliteral">&quot;ccpay_r_ordernum&quot;</span>) : 12345);

    <span class="comment">// post is asynchronous. while we&apos;re waiting, lock out the user so s/he doesn&apos;t try again</span>
    _transactions.enabled = <span class="keyword">false</span>;
    _void.enabled         = <span class="keyword">false</span>;

    var netreq = <span class="keyword">new</span> <a name="_a4"></a><a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qnetworkrequest.html">QNetworkRequest</a>();
    netreq.setUrl(_url);

    _netmgr.post(netreq, prequest);
  }
  <span class="keywordflow">catch</span> (e)
  {
    print(<span class="stringliteral">&quot;sVoid exception at &quot;</span> + e.lineNumber + <span class="stringliteral">&quot;: &quot;</span> + e);
    _transactions.enabled = <span class="keyword">true</span>;
    _void.enabled         = <span class="keyword">true</span>;
  }
}

function sHandleResponse(netresponse)
{
  <span class="keywordflow">try</span>
  {
    print(<span class="stringliteral">&quot;sHandleResponse entered&quot;</span>);
    <span class="keywordflow">if</span> (netresponse.error())
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error during data transfer&quot;</span>),
                   qsTr(<span class="stringliteral">&quot;&lt;p&gt;There was a network error trying to post the &quot;</span>
                      + <span class="stringliteral">&quot;transaction: %1.&quot;</span>
                      + <span class="stringliteral">&quot;Look up this error code at &quot;</span>
                      + <span class="stringliteral">&quot; &lt;a&gt;http://doc.trolltech.com/4.4/qnetworkreply.html&quot;</span>
                      + <span class="stringliteral">&quot;#NetworkError-enum&lt;/a&gt;&quot;</span>).arg(netresponse.error()));
      <span class="keywordflow">return</span>;
    }

    <span class="comment">// parse the reply, which is a QVariant(QByteArray) so first grab it as a string</span>
    var response = netresponse.readAll().toString();
    <span class="keywordflow">if</span> (response.match(/^&lt;HTML&gt;/i))
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error returned from A.N&quot;</span>),
                         response);
      <span class="keywordflow">return</span>;
    }

    <span class="comment">// field[N] here corresponds to fieldValue(..., N+1, ...) in the C++.</span>
    <span class="comment">// Authorize.Net uses 1-based arrays, JavaScript uses 0-based arrays, and</span>
    <span class="comment">// C++ uses 0-based arrays but the C++ function fieldValue translates</span>
    var field = response.split(metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>).length &gt; 0 ?
                                        metrics.value(<span class="stringliteral">&quot;CCANDelim&quot;</span>) : <span class="stringliteral">&quot;,&quot;</span>);
    var params = <span class="keyword">new</span> Object;
  
    <span class="keywordflow">if</span> (field[0] == 2)
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Declined&quot;</span>),
                           qsTr(<span class="stringliteral">&quot;The void transaction was declined&quot;</span>));
      <span class="keywordflow">return</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 3)
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error&quot;</span>),
                         qsTr(<span class="stringliteral">&quot;The void transaction received an error: %1&quot;</span>)
                         .arg(field[3]));
      <span class="keywordflow">return</span>;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 1)
      params.approved = <span class="stringliteral">&quot;APPROVED&quot;</span>;
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (field[0] == 4)
      params.approved = <span class="stringliteral">&quot;HELDFORREVIEW&quot;</span>;
    <span class="keywordflow">else</span>
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Error&quot;</span>),
                           qsTr(<span class="stringliteral">&quot;The void transaction received an unknown &quot;</span>
                              + <span class="stringliteral">&quot;approval value: %1&quot;</span>).arg(field[0]));
      <span class="keywordflow">return</span>;
    }

    params.amount     = _transactions.currentItem().rawValue(<span class="stringliteral">&quot;ccpay_amount&quot;</span>);
    params.ccpay_id   = _transactions.id;
    params.currid     = _currid;
    params.status     = <span class="stringliteral">&quot;V&quot;</span>;
    params.auth_charge= <span class="stringliteral">&quot;V&quot;</span>;
    params.type       = <span class="stringliteral">&quot;V&quot;</span>;
    params.reforder   = _transactions.column(<span class="stringliteral">&quot;docnumber&quot;</span>).text;
    params.avs        = field[5];
    params.ordernum   = <span class="stringliteral">&quot;&quot;</span>;
    params.xactionid  = field[6];
    params.code       = field[4];
    params.shipping   = field[34];
    params.tax        = field[32];
    params.ref        = <span class="stringliteral">&quot;&quot;</span>;
    params.message    = field[5];
    params.auth       = <span class="keyword">false</span>;

    <span class="comment">// report the result</span>
    var ccq = toolbox.executeQuery( 
             <span class="stringliteral">&apos;UPDATE ccpay SET&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;fromcurr&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;      ccpay_amount=ROUND(currToCurr(&lt;? value(&quot;fromcurr&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;                                    &lt;? value(&quot;tocurr&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;                                    &lt;? value(&quot;amount&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;                                    CURRENT_DATE), 2),&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_curr_id=&lt;? value(&quot;currid&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? else ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_amount=ROUND(&lt;? value(&quot;amount&quot;) ?&gt;, 2),&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_curr_id=&lt;? value(&quot;currid&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_auth=&lt;? value(&quot;auth&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_approved=&lt;? value(&quot;approved&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_avs=&lt;? value(&quot;avs&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_code=&lt;? value(&quot;code&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_error=&lt;? value(&quot;error&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_message=&lt;? value(&quot;message&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_ordernum=&lt;? value(&quot;ordernum&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_ref=&lt;? value(&quot;ref&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;shipping&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_shipping=&lt;? value(&quot;shipping&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;score&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_yp_r_score=&lt;? value(&quot;score&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;tax&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_r_tax=&lt;? value(&quot;tax&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;tdate&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_yp_r_tdate=&lt;? value(&quot;tdate&quot;) ?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;&lt;? if exists(&quot;time&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_yp_r_time=&lt;? value(&quot;time&quot;)?&gt;,&apos;</span>
           + <span class="stringliteral">&apos;&lt;? endif ?&gt;&apos;</span>
           + <span class="stringliteral">&apos;       ccpay_status=&lt;? value(&quot;status&quot;) ?&gt;&apos;</span>
           + <span class="stringliteral">&apos; WHERE (ccpay_id=&lt;? value(&quot;ccpay_id&quot;) ?&gt;);&apos;</span>,
           params);
    <span class="keywordflow">if</span> (ccq.lastError().type &gt; 0)
    {
      <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.critical(mywindow, qsTr(<span class="stringliteral">&quot;Query Failed&quot;</span>),
                         qsTr(<span class="stringliteral">&quot;There was an error querying the database: %1&quot;</span>)
                         .arg(ccq.lastError().text));
      <span class="keywordflow">return</span>;
    }

    <a class="codeRef" doxygen="qt.tags:http://qt.nokia.com/doc/4.6/" href="http://qt.nokia.com/doc/4.6/qmessagebox.html">QMessageBox</a>.information(mywindow, qsTr(<span class="stringliteral">&quot;Transaction Complete&quot;</span>),
                       qsTr(<span class="stringliteral">&quot;&lt;p&gt;The ccpay table has been updated after &quot;</span>
                          + <span class="stringliteral">&quot;completing the Void transaction.&quot;</span>));
    sPopulateTransactions();
  }
  <span class="keywordflow">catch</span> (e)
  {
    print(<span class="stringliteral">&quot;sHandleResponse exception at &quot;</span> + e.lineNumber + <span class="stringliteral">&quot;: &quot;</span> + e);
  }
  <span class="keywordflow">finally</span>
  {  <span class="comment">// allow the user to process another</span>
    print(<span class="stringliteral">&quot;sHandleResponse entered finally block&quot;</span>);
    _transactions.enabled = <span class="keyword">true</span>;
    _void.enabled         = (_transactions.id != -1);
  }
}

sPopulateTransactions();
</pre></div> </div>
  <hr size="1">
  <table width="100%">
    <tr>
      <td width="33%" style="text-align: left;"> Generated on Thu Dec 9 09:13:16 2010 </td>
      <td width="34%" style="text-align: center;"> xTuple ERP Programmer Reference, Version 3.6.0 </td>
      <td width="33%" style="text-align: right;">
        <a href="http://www.doxygen.org/index.html">
          <img src="doxygen.png" alt="doxygen" align="middle" border="0">
        </a> 1.6.1</address>
      </td>
    </tr>
  </table>
</body>
</html>
